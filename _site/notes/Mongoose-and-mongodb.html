<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Updating Entries in Mongoose/MongoDB</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Updating Entries in Mongoose/MongoDB" /><meta name="twitter:description" content="findOneAndUpdate"><meta name="description" content="findOneAndUpdate"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/Mongoose-and-mongodb"><link rel="alternate" type="application/atom+xml" title="Everything JS" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="http://i.imgur.com/lXpakuT.jpg?1" class="gravatar" width="80px"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Updating Entries in Mongoose/MongoDB</h1><time>January 17, 2016</time></div><div class="divider"></div><h3 id="findoneandupdate">findOneAndUpdate</h3><p>Updating an entry in MongoDB via Mongoose ORM can be conveniently achieved using the <code>findOneAndUpdate</code> function. Here’s an example with object stores that take this form:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="nx">age</span><span class="o">:</span> <span class="nb">Number</span><span class="p">,</span>
  <span class="nx">education</span><span class="o">:</span> <span class="nb">Array</span>
<span class="p">});</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Person&#39;</span><span class="p">,</span> <span class="nx">person</span><span class="p">);</span></code></pre></figure><p>To update that a particular person’s age, we can simply write:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Person</span><span class="p">.</span><span class="nx">findOneAndUpdate</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="s1">&#39;Kevin&#39;</span><span class="p">},</span> <span class="p">{</span><span class="nx">age</span><span class="o">:</span> <span class="mi">26</span><span class="p">});</span></code></pre></figure><p>In the above example, the update was rather straightforward; however if we were to update a particular entry in an array, the operation becomes more involved.</p><h3 id="update-an-embedded-array">Update an embedded array</h3><p>For example, the education field, containing an array of objects describing the schools this person has attended may need to be updated. And we do not wish to update the entire array, but only an entry of it. How would we achieve that?</p><blockquote><p><em>Disclaimer</em><br /> In many cases, it may make sense to use a SQL database since a larger dataset would have people and educational institutions stored as relational entries. However for the purpose of this post, exploring how to update a particular entry of the array, let’s assume the database is formed this way.</p></blockquote><p>Suppose this person went to GenericName High School, graduating in 2008, then to Famous University, graduating in 2012, followed by Some Research Institute, graduating in 2016. The eduction field of this person would then look like:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">[{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;76sd68f7g7&#39;</span>
  <span class="nx">school</span><span class="o">:</span> <span class="s1">&#39;GenericName High School&#39;</span><span class="p">,</span>
  <span class="nx">graduatingYear</span><span class="o">:</span> <span class="mi">2008</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;9a7df87s96&#39;</span>
  <span class="nx">school</span><span class="o">:</span> <span class="s1">&#39;Famous University&#39;</span><span class="p">,</span>
  <span class="nx">graduatingYear</span><span class="o">:</span> <span class="mi">2012</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;987sdf987s&#39;</span>
  <span class="nx">school</span><span class="o">:</span> <span class="err">&#39;</span><span class="nx">Some</span> <span class="nx">Research</span> <span class="nx">Institution</span><span class="p">,</span>
  <span class="nx">graduatingYear</span><span class="o">:</span> <span class="mi">2016</span>
<span class="p">}]</span></code></pre></figure><p>We can gain access to to the object via <code>findOne</code> then operate on the array as needed, then perform a <code>.save()</code> operation. So in case we want to highschool entry entirely, the code would take the following form:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Person</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Kevin&#39;</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">foundPerson</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">foundPerson</span><span class="p">.</span><span class="nx">education</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">foundPerson</span><span class="p">.</span><span class="nx">education</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_id</span> <span class="o">===</span> <span class="s1">&#39;76sd68f7g7&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">foundPerson</span><span class="p">.</span><span class="nx">education</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">foundPerson</span><span class="p">.</span><span class="nx">education</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;7a5fjh4871&#39;</span><span class="p">,</span>
        <span class="nx">school</span><span class="o">:</span> <span class="s1">&#39;Another High School&#39;</span><span class="p">,</span>
        <span class="nx">graduatingYear</span><span class="o">:</span> <span class="mi">2008</span>
      <span class="p">});</span>
      <span class="nx">foundPerson</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// in case that person was not found</span>
  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No such school with this _id&#39;</span><span class="p">));</span>
<span class="p">});</span></code></pre></figure><p><em>Note!</em><br /> Why did we use splice operation twice instead of <code>foundPerson.education[i] = {}</code> directly?</p><p>Mongoose does not recognize that as a change on the foundPerson, and therefore the <code>.save()</code> operation would not actually save the updated person.</p><p>Using <code>splice</code> here forces Mongoose to recognize the change therefore the save function behaves correctly as a result.</p><h3 id="built-in-mongodb-update-methods">Built-in MongoDB Update methods</h3><p>You might be wondering doesn’t MongoDB support embedded field updates for arrays? The answer is yes. Checkout these pages for excellent explanations:</p><ul><li><a href="https://docs.mongodb.org/manual/tutorial/modify-documents/#update-an-embedded-field">Updating Embedded Field in MongoDB</a></li><li><a href="https://docs.mongodb.org/manual/core/document/#dot-notation">Dot Notation in MongoDB</a></li><li><a href="https://docs.mongodb.org/manual/tutorial/query-documents/#arrays">Arrays in MongoDB</a></li><li><a href="https://docs.mongodb.org/manual/reference/operator/update/">Update Operators in MongoDB</a></li></ul><p>Both methods have its advantages, and disadvantages. It depends on the situation. Choose wisely.</p></article><div class="back"> <a href="/">Back</a></div></main></body></html>