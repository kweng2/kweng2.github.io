<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Connecting Web Audio API To A Source File</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Connecting Web Audio API To A Source File" /><meta name="twitter:description" content="In attempting to use the Web Audio API to visualize an audio file, I found plenty of helpful documents, particularly on the MDN documentation. I highly recommend spending some time reading through ..."><meta name="description" content="In attempting to use the Web Audio API to visualize an audio file, I found plenty of helpful documents, particularly on the MDN documentation. I highly recom..."><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/connecting-web-audio-api-to-a-source-file"><link rel="alternate" type="application/atom+xml" title="Everything JS" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="http://i.imgur.com/lXpakuT.jpg?1" class="gravatar" width="80px"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Connecting Web Audio API To A Source File</h1><time>December 12, 2015</time></div><div class="divider"></div><p>In attempting to use the Web Audio API to visualize an audio file, I found plenty of helpful documents, particularly on the MDN documentation. I highly recommend spending some time reading through the relevant documentation before starting.</p><p>The examples on the MDN site are really helpful in understanding inputs, outputs, and purpose of each method, but I had trouble linking everything together. So here’s an example of visualizing a local sound file to a canvas element on a blank HTML page:</p><p><strong>First, let’s create an html audio tag:</strong></p><div class="highlighter-rouge"><pre class="highlight"><code>&lt;audio controls&gt;
  &lt;source src = "sound.mp3" type = "audio/mpeg"&gt;
&lt;/audio&gt;
</code></pre></div><p><strong>Next</strong>, create a audio context somewhere in the JS script. Use that audio context to create a media source node by passing in the audio element:</p><div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">audioCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">audioElement</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'audio'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">createMediaElementSource</span><span class="p">(</span><span class="nx">audioElement</span><span class="p">);</span>
</code></pre></div><p>Note here, that we need to access the zeroth element of wrapped jQuery object.</p><p><strong>Next</strong>, create an analyzer node, which can do all the cool stuff, then link it to the source node:</p><div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">analyser</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">createAnalyser</span><span class="p">();</span>
<span class="nx">source</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">analyser</span><span class="p">);</span>
</code></pre></div><p>Now, almost everything is connected. When the source variable was created, the audio context assumes that that you’re interested in doing something with the source file, such as distorting the sound, adding reverbs, etc. As such, the audio context automatically forces the audio source to not be output to the speakers, unless otherwise instructed. To ensure that the audio file still plays, <strong>connect the source to the audio context’s destination</strong>, usually speakers:</p><div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">source</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</code></pre></div><p>Now everything is in place! Start getting data from the analyzer and plot them. For this example, plot the volume on the y-axis, and the frequency on the x-axis:</p><div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'canvas'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">canvasCtx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">'2d'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">freqDomain</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">analyser</span><span class="p">.</span><span class="nx">frequencyBinCount</span><span class="p">);</span>
  <span class="nx">analyser</span><span class="p">.</span><span class="nx">getByteFrequencyData</span><span class="p">(</span><span class="nx">freqDomain</span><span class="p">);</span>
  <span class="nx">canvasCtx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">WIDTH</span><span class="p">,</span><span class="nx">HEIGHT</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">analyser</span><span class="p">.</span><span class="nx">frequencyBinCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">freqDomain</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">percent</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">HEIGHT</span> <span class="o">*</span> <span class="nx">percent</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">HEIGHT</span> <span class="o">-</span> <span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">barWidth</span> <span class="o">=</span> <span class="nx">WIDTH</span><span class="o">/</span><span class="nx">analyser</span><span class="p">.</span><span class="nx">frequencyBinCount</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hue</span> <span class="o">=</span> <span class="nx">i</span><span class="o">/</span><span class="nx">analyser</span><span class="p">.</span><span class="nx">frequencyBinCount</span> <span class="o">*</span> <span class="mi">360</span><span class="p">;</span>
    <span class="nx">canvasCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">"rgb(200,0,0)"</span><span class="p">;</span>
    <span class="nx">canvasCtx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">barWidth</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">barWidth</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">draw</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">draw</span><span class="p">();</span>
</code></pre></div><p>Hope that helps!</p><p>Check out the repo at <a href="https://github.com/kweng2/WebAudioViz">https://github.com/kweng2/WebAudioViz</a></p><p>It’s also hosted here: <a href="http://kweng2.github.io/WebAudioViz/index.html">http://kweng2.github.io/WebAudioViz/index.html</a></p></article><div class="back"> <a href="/">Back</a></div></main></body></html>