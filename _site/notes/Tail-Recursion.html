<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Tail Recursion Optimization Applied</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Tail Recursion Optimization Applied" /><meta name="twitter:description" content="ES6 supports tail call optimization. How can we take advantage of this and what does it enable?"><meta name="description" content="ES6 supports tail call optimization. How can we take advantage of this and what does it enable?"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/Tail-Recursion"><link rel="alternate" type="application/atom+xml" title="Everything JS" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="http://i.imgur.com/lXpakuT.jpg?1" class="gravatar" width="80px"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Tail Recursion Optimization Applied</h1><time>February 4, 2016</time></div><div class="divider"></div><p>ES6 supports tail call optimization. How can we take advantage of this and what does it enable?</p><h3 id="what-is-it">What is it?</h3><p>Suppose we are trying to find the max call stack size</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">findMaxStackSize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">findMaxStackSize</span><span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">findMaxStackSize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div><p>Each time <code class="highlighter-rouge">findMaxStackSize</code> is called, since it is nested within a function call, it gets added to the call stack. Eventually, the call stack will be full and throw an error.</p><h3 id="es6-to-the-rescue">ES6 To The Rescue</h3><p>ES6 notices that the function call of <code class="highlighter-rouge">findMaxStackSize</code> is the last operation in the current function call, and therefore no longer needs to keep track of the current execution context. As a result, when the next <code class="highlighter-rouge">findMaxStackSize</code> is called, the call stack does not increase, and therefore this function can run forever!</p><h3 id="so-what">So What?</h3><p>A particular application is using a recursed <a href="http://redis.io/commands/BLPOP">redis list</a> and its <a href="http://redis.io/topics/data-types">blocking pop</a> as a load balancer. With this tail call recursion support, this blocking pop operation can run indefinitely!</p><p>Hereâ€™s what that would look like:</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'redis'</span><span class="p">).</span><span class="nx">createClient</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">keepListening</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">blpop</span><span class="p">(</span><span class="s1">'LIST_NAME'</span><span class="p">,</span> <span class="nx">TIMEOUT</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do something with the popped element, response</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
    <span class="nx">keepListening</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">keepListening</span><span class="p">();</span>
</code></pre></div><p>This code block uses the <code class="highlighter-rouge">redis</code> node module and its invocation of the blocking operation. This function will log the element being popped from the redis list called <code class="highlighter-rouge">'LIST_NAME'</code>, then call itself. Since it is the last operation in its current execution context, tail-recursion optimized interpreter will NOT add to the call stack, thereby allowing this function to run indefinitely.</p><p>This is just one use case. Let me know if you find another cool use case.</p></article><div class="back"> <a href="/">Back</a></div></main></body></html>